---
layout: post
title: 高性能mysql笔记
---

## 此笔记只针对mysql5.5

### mysql的架构
- mysql采用存储和处理分离的架构。
- mysql可以开启线程池，处理客户端的请求。
- select语句会在缓存中先查找，没有hit才会到解释器。
- 解释器创建内部数据结构并做优化，最后才到存储器API。优化决策时用户可以使用hint关键字来影响mysql的决策过程，也可能使用explain来看看mysql是怎么决策的。
优化器会请求存储引擎提供一些信息来帮助优化。

### mysql的并发控制
- mysql在服务层和存储层都做了并发控制， 一般使用锁来控制并发。
- 存储引擎有自己的锁策略和颗粒度，但是服务层的策略高于存储层。比如alter table 使用应用层的表锁，忽略存储层锁机制。
- 行锁只有在存储层实现, 一般通过多版本并发控制MVCC, 提升并发性能。简单原理是一个事务看到的是某一时刻数据的备份。
- 可以显式地加锁：
  - `select ... lock in share mode;`
  - `select ... for update;`

### 事务只有在存储引擎实现
- 需要格外小心事务中混合了事务型和非事务型表

### ACID是一个事务的标准特征
- mysql主要关心两个隔离等级，Read commited 和 repeatable read。 read commited也是nonrepeatable read, 一个事务在commit之前对其他事务都是不可见的。
repeatable read是mysql默认隔离等级，保证同一个事务多次读取同样记录结果一致。
- 在多个事务里可能出现死锁现象, innoDB处理的方式是将最少行级排它锁进行回滚。

### 使用事务日志可以提高存储引擎修改表数据效率
- 做法类似redis, 仅仅持久化事务日志，在内存中更新数据，然后后台再慢慢写入磁盘。

### Mysql提供两种事务性存储引擎InnoDB, NBD cluster
- 自动提交： 默认开启，即便不是显式开启，每个查询还是会默认进行事务。

### 设计mysql备份方案
- 逻辑备份恢复太慢，采用ExtraBackup快照备份是物理备份较好的选择。
- 保留多个备份集
- 定期恢复
- **expire_logs_bin** 设置足够长，保留二进制日志文件用于基于时间点的恢复。
- 监控和检查备份是否正常？监控恢复需要耗费多少资源和时间？
- 选择在线备份，可能是导致mysql服务中断
- 逻辑备份导出的文件要么是sql要么是类似csv的文本；物理备份就是直接复制原始文件。
  - 逻辑备份的优点：
    - 逻辑备份可以消除底层存储引擎的影响
    - 如果内存保存着正确数据但是磁盘坏了，这是导出的可能是一个正常的逻辑备份
  - 逻辑备份的缺点： 
    - 需要消耗cpu，恢复时间较长
    - ASCII形式的数据可能比原始数据大
    - 恢复时可能由于bug或者浮点表示问题，无法保证还原一模一样的数据。
  - 物理备份的优点：
    - 恢复快速， 不需要执行任何sql或构建索引
  - 物理备份的缺点：
    - 原始文件比逻辑备份大
    - 可能不总是夸平台
- 使用check tables 执行恢复操作。
### 推荐的备份方案
- 先使用物理备份，启动mysql实例，运行mysqlcheck, 然后在服务器负载低时周期性地mysqldump执行逻辑备份。
